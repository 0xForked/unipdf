//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_a "crypto/md5";_egf "encoding/hex";_cfc "errors";_ec "fmt";_gd "github.com/unidoc/unipdf/v3/common";_aa "github.com/unidoc/unipdf/v3/core";_g "image";_d "image/png";_cf "io";_cb "os";_aef "os/exec";_c "path/filepath";_eg "strings";
_ae "testing";);func HashFile (file string )(string ,error ){_ac ,_b :=_cb .Open (file );if _b !=nil {return "",_b ;};defer _ac .Close ();_dc :=_a .New ();if _ ,_b =_cf .Copy (_dc ,_ac );_b !=nil {return "",_b ;};return _egf .EncodeToString (_dc .Sum (nil )),nil ;
};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_aba ,_db :=HashFile (file1 );if _db !=nil {return false ,_db ;};_ee ,_db :=HashFile (file2 );if _db !=nil {return false ,_db ;};if _aba ==_ee {return true ,nil ;};_gg ,_db :=ReadPNG (file1 );
if _db !=nil {return false ,_db ;};_dg ,_db :=ReadPNG (file2 );if _db !=nil {return false ,_db ;};if _gg .Bounds ()!=_dg .Bounds (){return false ,nil ;};return CompareImages (_gg ,_dg );};func ReadPNG (file string )(_g .Image ,error ){_ed ,_ff :=_cb .Open (file );
if _ff !=nil {return nil ,_ff ;};defer _ed .Close ();return _d .Decode (_ed );};func _ccb (_dcf _aa .PdfObject ,_df map[int64 ]_aa .PdfObject )error {switch _afd :=_dcf .(type ){case *_aa .PdfIndirectObject :_aed :=_afd ;_ccb (_aed .PdfObject ,_df );case *_aa .PdfObjectDictionary :_eaa :=_afd ;
for _ ,_gdb :=range _eaa .Keys (){_gc :=_eaa .Get (_gdb );if _gaa ,_dgc :=_gc .(*_aa .PdfObjectReference );_dgc {_dd ,_bc :=_df [_gaa .ObjectNumber ];if !_bc {return _cfc .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_eaa .Set (_gdb ,_dd );}else {_ccb (_gc ,_df );};};case *_aa .PdfObjectArray :_gbc :=_afd ;for _ddd ,_gga :=range _gbc .Elements (){if _fgc ,_fgcc :=_gga .(*_aa .PdfObjectReference );_fgcc {_ccbb ,_gbcc :=_df [_fgc .ObjectNumber ];if !_gbcc {return _cfc .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_gbc .Set (_ddd ,_ccbb );}else {_ccb (_gga ,_df );};};};return nil ;};func CompareDictionariesDeep (d1 ,d2 *_aa .PdfObjectDictionary )bool {if len (d1 .Keys ())!=len (d2 .Keys ()){_gd .Log .Debug ("\u0044\u0069\u0063\u0074\u0020\u0065\u006e\u0074\u0072\u0069\u0065\u0073\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",len (d1 .Keys ()),len (d2 .Keys ()));
_gd .Log .Debug ("\u0057\u0061s\u0020\u0027\u0025s\u0027\u0020\u0076\u0073\u0020\u0027\u0025\u0073\u0027",d1 .WriteString (),d2 .WriteString ());return false ;};for _ ,_gfbe :=range d1 .Keys (){if _gfbe =="\u0050\u0061\u0072\u0065\u006e\u0074"{continue ;
};_dfc :=_aa .TraceToDirectObject (d1 .Get (_gfbe ));_be :=_aa .TraceToDirectObject (d2 .Get (_gfbe ));if _dfc ==nil {_gd .Log .Debug ("\u00761\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};if _be ==nil {_gd .Log .Debug ("\u00762\u0020\u0069\u0073\u0020\u006e\u0069l");
return false ;};switch _bgf :=_dfc .(type ){case *_aa .PdfObjectDictionary :_ccc ,_bda :=_be .(*_aa .PdfObjectDictionary );if !_bda {_gd .Log .Debug ("\u0054\u0079\u0070\u0065 m\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0020\u0025\u0054\u0020\u0076\u0073\u0020%\u0054",_dfc ,_be );
return false ;};if !CompareDictionariesDeep (_bgf ,_ccc ){return false ;};continue ;case *_aa .PdfObjectArray :_afc ,_bde :=_be .(*_aa .PdfObjectArray );if !_bde {_gd .Log .Debug ("\u00762\u0020n\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");
return false ;};if _bgf .Len ()!=_afc .Len (){_gd .Log .Debug ("\u0061\u0072\u0072\u0061\u0079\u0020\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",_bgf .Len (),_afc .Len ());
return false ;};for _ace :=0;_ace < _bgf .Len ();_ace ++{_bea :=_aa .TraceToDirectObject (_bgf .Get (_ace ));_afa :=_aa .TraceToDirectObject (_afc .Get (_ace ));if _ef ,_gabe :=_bea .(*_aa .PdfObjectDictionary );_gabe {_bdc ,_aaa :=_afa .(*_aa .PdfObjectDictionary );
if !_aaa {return false ;};if !CompareDictionariesDeep (_ef ,_bdc ){return false ;};}else {if _bea .WriteString ()!=_afa .WriteString (){_gd .Log .Debug ("M\u0069\u0073\u006d\u0061tc\u0068 \u0027\u0025\u0073\u0027\u0020!\u003d\u0020\u0027\u0025\u0073\u0027",_bea .WriteString (),_afa .WriteString ());
return false ;};};};continue ;};if _dfc .String ()!=_be .String (){_gd .Log .Debug ("\u006b\u0065y\u003d\u0025\u0073\u0020\u004d\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0021\u0020\u0027\u0025\u0073\u0027\u0020\u0021\u003d\u0020'%\u0073\u0027",_gfbe ,_dfc .String (),_be .String ());
_gd .Log .Debug ("\u0046o\u0072 \u0027\u0025\u0054\u0027\u0020\u002d\u0020\u0027\u0025\u0054\u0027",_dfc ,_be );_gd .Log .Debug ("\u0046\u006f\u0072\u0020\u0027\u0025\u002b\u0076\u0027\u0020\u002d\u0020'\u0025\u002b\u0076\u0027",_dfc ,_be );return false ;
};};return true ;};func CompareImages (img1 ,img2 _g .Image )(bool ,error ){_gf :=img1 .Bounds ();_aca :=0;for _acd :=0;_acd < _gf .Size ().X ;_acd ++{for _gfb :=0;_gfb < _gf .Size ().Y ;_gfb ++{_bf ,_ga ,_ag ,_ :=img1 .At (_acd ,_gfb ).RGBA ();_aee ,_gag ,_acf ,_ :=img2 .At (_acd ,_gfb ).RGBA ();
if _bf !=_aee ||_ga !=_gag ||_ag !=_acf {_aca ++;};};};_gb :=float64 (_aca )/float64 (_gf .Dx ()*_gf .Dy ());if _gb > 0.0001{_ec .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_gb ,_aca );
return false ,nil ;};return true ,nil ;};func RunRenderTest (t *_ae .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ){_fff :=_eg .TrimSuffix (_c .Base (pdfPath ),_c .Ext (pdfPath ));t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_gdd *_ae .T ){_gdda :=_c .Join (outputDir ,_fff );
_bd :=_gdda +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _eec :=RenderPDFToPNGs (pdfPath ,0,_bd );_eec !=nil {_gdd .Skip (_eec );};for _cd :=1;true ;_cd ++{_eb :=_ec .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_gdda ,_cd );_eef :=_c .Join (baselineRenderPath ,_ec .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_fff ,_cd ));
if _ ,_fd :=_cb .Stat (_eb );_fd !=nil {break ;};_gdd .Logf ("\u0025\u0073",_eef );if saveBaseline {_gdd .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_eb ,_eef );_abb :=CopyFile (_eb ,_eef );if _abb !=nil {_gdd .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_eef ,_abb );
};continue ;};_gdd .Run (_ec .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_cd ),func (_gab *_ae .T ){_gab .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_eb ,_eef );_ffe ,_gda :=ComparePNGFiles (_eb ,_eef );
if _cb .IsNotExist (_gda ){_gab .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_ffe {_gab .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func CopyFile (src ,dst string )error {_ea ,_ab :=_cb .Open (src );if _ab !=nil {return _ab ;};defer _ea .Close ();_da ,_ab :=_cb .Create (dst );if _ab !=nil {return _ab ;};defer _da .Close ();_ ,_ab =_cf .Copy (_da ,_ea );return _ab ;};func ParseIndirectObjects (rawpdf string )(map[int64 ]_aa .PdfObject ,error ){_cc :=_aa .NewParserFromString (rawpdf );
_gdc :=map[int64 ]_aa .PdfObject {};for {_af ,_ba :=_cc .ParseIndirectObject ();if _ba !=nil {if _ba ==_cf .EOF {break ;};return nil ,_ba ;};switch _bg :=_af .(type ){case *_aa .PdfIndirectObject :_gdc [_bg .ObjectNumber ]=_af ;case *_aa .PdfObjectStream :_gdc [_bg .ObjectNumber ]=_af ;
};};for _ ,_de :=range _gdc {_ccb (_de ,_gdc );};return _gdc ,nil ;};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;};if _ ,_fb :=_aef .LookPath ("\u0067\u0073");_fb !=nil {return ErrRenderNotSupported ;};return _aef .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_ec .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};var (ErrRenderNotSupported =_cfc .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
);