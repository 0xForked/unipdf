//
// Copyright 2020 FoxyUtils ehf. All rights reserved.
//
// This is a commercial product and requires a license to operate.
// A trial license can be obtained at https://unidoc.io
//
// DO NOT EDIT: generated by unitwist Go source code obfuscator.
//
// Use of this source code is governed by the UniDoc End User License Agreement
// terms that can be accessed at https://unidoc.io/eula/

package testutils ;import (_g "crypto/md5";_bc "encoding/hex";_f "errors";_c "fmt";_aa "github.com/unidoc/unipdf/v3/common";_ce "github.com/unidoc/unipdf/v3/core";_gf "image";_af "image/png";_eb "io";_a "os";_d "os/exec";_ge "path/filepath";_ba "strings";
_b "testing";);func _afc (_cd _ce .PdfObject ,_bd map[int64 ]_ce .PdfObject )error {switch _bae :=_cd .(type ){case *_ce .PdfIndirectObject :_ega :=_bae ;_afc (_ega .PdfObject ,_bd );case *_ce .PdfObjectDictionary :_baf :=_bae ;for _ ,_gg :=range _baf .Keys (){_fg :=_baf .Get (_gg );
if _ee ,_gec :=_fg .(*_ce .PdfObjectReference );_gec {_cfd ,_ecc :=_bd [_ee .ObjectNumber ];if !_ecc {return _f .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_baf .Set (_gg ,_cfd );}else {_afc (_fg ,_bd );};};case *_ce .PdfObjectArray :_acd :=_bae ;for _df ,_ebgb :=range _acd .Elements (){if _cb ,_fde :=_ebgb .(*_ce .PdfObjectReference );_fde {_ceae ,_bdf :=_bd [_cb .ObjectNumber ];if !_bdf {return _f .New ("r\u0065\u0066\u0065\u0072\u0065\u006ec\u0065\u0020\u0074\u006f\u0020\u006f\u0075\u0074\u0073i\u0064\u0065\u0020o\u0062j\u0065\u0063\u0074");
};_acd .Set (_df ,_ceae );}else {_afc (_ebgb ,_bd );};};};return nil ;};func ComparePNGFiles (file1 ,file2 string )(bool ,error ){_age ,_ac :=HashFile (file1 );if _ac !=nil {return false ,_ac ;};_ceg ,_ac :=HashFile (file2 );if _ac !=nil {return false ,_ac ;
};if _age ==_ceg {return true ,nil ;};_eab ,_ac :=ReadPNG (file1 );if _ac !=nil {return false ,_ac ;};_gde ,_ac :=ReadPNG (file2 );if _ac !=nil {return false ,_ac ;};if _eab .Bounds ()!=_gde .Bounds (){return false ,nil ;};return CompareImages (_eab ,_gde );
};func CopyFile (src ,dst string )error {_bcb ,_dc :=_a .Open (src );if _dc !=nil {return _dc ;};defer _bcb .Close ();_gc ,_dc :=_a .Create (dst );if _dc !=nil {return _dc ;};defer _gc .Close ();_ ,_dc =_eb .Copy (_gc ,_bcb );return _dc ;};func ParseIndirectObjects (rawpdf string )(map[int64 ]_ce .PdfObject ,error ){_gcd :=_ce .NewParserFromString (rawpdf );
_fbd :=map[int64 ]_ce .PdfObject {};for {_eg ,_ec :=_gcd .ParseIndirectObject ();if _ec !=nil {if _ec ==_eb .EOF {break ;};return nil ,_ec ;};switch _eac :=_eg .(type ){case *_ce .PdfIndirectObject :_fbd [_eac .ObjectNumber ]=_eg ;case *_ce .PdfObjectStream :_fbd [_eac .ObjectNumber ]=_eg ;
};};for _ ,_ffe :=range _fbd {_afc (_ffe ,_fbd );};return _fbd ,nil ;};func HashFile (file string )(string ,error ){_bg ,_gd :=_a .Open (file );if _gd !=nil {return "",_gd ;};defer _bg .Close ();_ga :=_g .New ();if _ ,_gd =_eb .Copy (_ga ,_bg );_gd !=nil {return "",_gd ;
};return _bc .EncodeToString (_ga .Sum (nil )),nil ;};func RunRenderTest (t *_b .T ,pdfPath ,outputDir ,baselineRenderPath string ,saveBaseline bool ){_cf :=_ba .TrimSuffix (_ge .Base (pdfPath ),_ge .Ext (pdfPath ));t .Run ("\u0072\u0065\u006e\u0064\u0065\u0072",func (_be *_b .T ){_fe :=_ge .Join (outputDir ,_cf );
_cg :=_fe +"\u002d%\u0064\u002e\u0070\u006e\u0067";if _ae :=RenderPDFToPNGs (pdfPath ,0,_cg );_ae !=nil {_be .Skip (_ae );};for _ebf :=1;true ;_ebf ++{_fb :=_c .Sprintf ("\u0025s\u002d\u0025\u0064\u002e\u0070\u006eg",_fe ,_ebf );_gac :=_ge .Join (baselineRenderPath ,_c .Sprintf ("\u0025\u0073\u002d\u0025\u0064\u005f\u0065\u0078\u0070\u002e\u0070\u006e\u0067",_cf ,_ebf ));
if _ ,_bce :=_a .Stat (_fb );_bce !=nil {break ;};_be .Logf ("\u0025\u0073",_gac );if saveBaseline {_be .Logf ("\u0043\u006fp\u0079\u0069\u006eg\u0020\u0025\u0073\u0020\u002d\u003e\u0020\u0025\u0073",_fb ,_gac );_bcbb :=CopyFile (_fb ,_gac );if _bcbb !=nil {_be .Fatalf ("\u0045\u0052\u0052OR\u0020\u0063\u006f\u0070\u0079\u0069\u006e\u0067\u0020\u0074\u006f\u0020\u0025\u0073\u003a\u0020\u0025\u0076",_gac ,_bcbb );
};continue ;};_be .Run (_c .Sprintf ("\u0070\u0061\u0067\u0065\u0025\u0064",_ebf ),func (_baa *_b .T ){_baa .Logf ("\u0043o\u006dp\u0061\u0072\u0069\u006e\u0067 \u0025\u0073 \u0076\u0073\u0020\u0025\u0073",_fb ,_gac );_dbb ,_ebfa :=ComparePNGFiles (_fb ,_gac );
if _a .IsNotExist (_ebfa ){_baa .Fatal ("\u0069m\u0061g\u0065\u0020\u0066\u0069\u006ce\u0020\u006di\u0073\u0073\u0069\u006e\u0067");}else if !_dbb {_baa .Fatal ("\u0077\u0072\u006f\u006eg \u0070\u0061\u0067\u0065\u0020\u0072\u0065\u006e\u0064\u0065\u0072\u0065\u0064");
};});};});};func RenderPDFToPNGs (pdfPath string ,dpi int ,outpathTpl string )error {if dpi <=0{dpi =100;};if _ ,_gfg :=_d .LookPath ("\u0067\u0073");_gfg !=nil {return ErrRenderNotSupported ;};return _d .Command ("\u0067\u0073","\u002d\u0073\u0044\u0045\u0056\u0049\u0043\u0045\u003d\u0070\u006e\u0067a\u006c\u0070\u0068\u0061","\u002d\u006f",outpathTpl ,_c .Sprintf ("\u002d\u0072\u0025\u0064",dpi ),pdfPath ).Run ();
};var (ErrRenderNotSupported =_f .New ("\u0072\u0065\u006e\u0064\u0065r\u0069\u006e\u0067\u0020\u0050\u0044\u0046\u0020\u0066\u0069\u006c\u0065\u0073 \u0069\u0073\u0020\u006e\u006f\u0074\u0020\u0073\u0075\u0070\u0070\u006f\u0072\u0074\u0065\u0064\u0020\u006f\u006e\u0020\u0074\u0068\u0069\u0073\u0020\u0073\u0079\u0073\u0074\u0065m");
);func ReadPNG (file string )(_gf .Image ,error ){_ebg ,_cea :=_a .Open (file );if _cea !=nil {return nil ,_cea ;};defer _ebg .Close ();return _af .Decode (_ebg );};func CompareImages (img1 ,img2 _gf .Image )(bool ,error ){_fa :=img1 .Bounds ();_abg :=0;
for _ea :=0;_ea < _fa .Size ().X ;_ea ++{for _ff :=0;_ff < _fa .Size ().Y ;_ff ++{_ed ,_db ,_ag ,_ :=img1 .At (_ea ,_ff ).RGBA ();_dg ,_bf ,_fd ,_ :=img2 .At (_ea ,_ff ).RGBA ();if _ed !=_dg ||_db !=_bf ||_ag !=_fd {_abg ++;};};};_ad :=float64 (_abg )/float64 (_fa .Dx ()*_fa .Dy ());
if _ad > 0.0001{_c .Printf ("\u0064\u0069\u0066f \u0066\u0072\u0061\u0063\u0074\u0069\u006f\u006e\u003a\u0020\u0025\u0076\u0020\u0028\u0025\u0064\u0029\u000a",_ad ,_abg );return false ,nil ;};return true ,nil ;};func CompareDictionariesDeep (d1 ,d2 *_ce .PdfObjectDictionary )bool {if len (d1 .Keys ())!=len (d2 .Keys ()){_aa .Log .Debug ("\u0044\u0069\u0063\u0074\u0020\u0065\u006e\u0074\u0072\u0069\u0065\u0073\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",len (d1 .Keys ()),len (d2 .Keys ()));
_aa .Log .Debug ("\u0057\u0061s\u0020\u0027\u0025s\u0027\u0020\u0076\u0073\u0020\u0027\u0025\u0073\u0027",d1 .WriteString (),d2 .WriteString ());return false ;};for _ ,_ecg :=range d1 .Keys (){if _ecg =="\u0050\u0061\u0072\u0065\u006e\u0074"{continue ;
};_eaca :=_ce .TraceToDirectObject (d1 .Get (_ecg ));_adb :=_ce .TraceToDirectObject (d2 .Get (_ecg ));if _eaca ==nil {_aa .Log .Debug ("\u00761\u0020\u0069\u0073\u0020\u006e\u0069l");return false ;};if _adb ==nil {_aa .Log .Debug ("\u00762\u0020\u0069\u0073\u0020\u006e\u0069l");
return false ;};switch _dga :=_eaca .(type ){case *_ce .PdfObjectDictionary :_bab ,_ggb :=_adb .(*_ce .PdfObjectDictionary );if !_ggb {_aa .Log .Debug ("\u0054\u0079\u0070\u0065 m\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0020\u0025\u0054\u0020\u0076\u0073\u0020%\u0054",_eaca ,_adb );
return false ;};if !CompareDictionariesDeep (_dga ,_bab ){return false ;};continue ;case *_ce .PdfObjectArray :_cfe ,_ecgd :=_adb .(*_ce .PdfObjectArray );if !_ecgd {_aa .Log .Debug ("\u00762\u0020n\u006f\u0074\u0020\u0061\u006e\u0020\u0061\u0072\u0072\u0061\u0079");
return false ;};if _dga .Len ()!=_cfe .Len (){_aa .Log .Debug ("\u0061\u0072\u0072\u0061\u0079\u0020\u006c\u0065\u006e\u0067\u0074\u0068\u0020\u006d\u0069s\u006da\u0074\u0063\u0068\u0020\u0028\u0025\u0064\u0020\u0021\u003d\u0020\u0025\u0064\u0029",_dga .Len (),_cfe .Len ());
return false ;};for _fc :=0;_fc < _dga .Len ();_fc ++{_baab :=_ce .TraceToDirectObject (_dga .Get (_fc ));_bb :=_ce .TraceToDirectObject (_cfe .Get (_fc ));if _eda ,_gda :=_baab .(*_ce .PdfObjectDictionary );_gda {_geab ,_bac :=_bb .(*_ce .PdfObjectDictionary );
if !_bac {return false ;};if !CompareDictionariesDeep (_eda ,_geab ){return false ;};}else {if _baab .WriteString ()!=_bb .WriteString (){_aa .Log .Debug ("M\u0069\u0073\u006d\u0061tc\u0068 \u0027\u0025\u0073\u0027\u0020!\u003d\u0020\u0027\u0025\u0073\u0027",_baab .WriteString (),_bb .WriteString ());
return false ;};};};continue ;};if _eaca .String ()!=_adb .String (){_aa .Log .Debug ("\u006b\u0065y\u003d\u0025\u0073\u0020\u004d\u0069\u0073\u006d\u0061\u0074\u0063\u0068\u0021\u0020\u0027\u0025\u0073\u0027\u0020\u0021\u003d\u0020'%\u0073\u0027",_ecg ,_eaca .String (),_adb .String ());
_aa .Log .Debug ("\u0046o\u0072 \u0027\u0025\u0054\u0027\u0020\u002d\u0020\u0027\u0025\u0054\u0027",_eaca ,_adb );_aa .Log .Debug ("\u0046\u006f\u0072\u0020\u0027\u0025\u002b\u0076\u0027\u0020\u002d\u0020'\u0025\u002b\u0076\u0027",_eaca ,_adb );return false ;
};};return true ;};